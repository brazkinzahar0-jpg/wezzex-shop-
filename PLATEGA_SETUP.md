# Интеграция Platega.io

Этот документ описывает процесс настройки платежной системы Platega.io в проекте remnashop.

## Обзор

Platega.io — платежная система, поддерживающая различные методы оплаты, включая СБП QR-коды. Интеграция полностью реализована и готова к использованию.

## Требования

1. Аккаунт в Platega.io с полученными учетными данными:
   - `MerchantId` (X-MerchantId)
   - `API Secret` (X-Secret)

2. Настроенный домен для приема webhook'ов от Platega

## Настройка

### 1. Получение учетных данных

Учетные данные выдаются менеджером при подключении или доступны в личном кабинете Platega.io на странице «Настройки».

### 2. Настройка в базе данных

Platega настраивается через интерфейс бота или напрямую в базе данных. Необходимо указать:

- **merchant_id**: Ваш MerchantId от Platega
- **api_secret**: Ваш API Secret от Platega

### 3. Настройка Webhook URL

В личном кабинете Platega.io необходимо указать URL для приема callback'ов:

```
https://ваш-домен.com/api/v1/payments/platega
```

Где `ваш-домен.com` — это значение переменной окружения `APP_DOMAIN`.

### 4. Проверка настроек

После настройки убедитесь, что:

1. Платежный шлюз активирован в системе (`is_active = true`)
2. Указаны корректные `merchant_id` и `api_secret`
3. Webhook URL правильно настроен в личном кабинете Platega
4. Домен доступен из интернета для приема webhook'ов

## Использование

После настройки Platega будет доступен как один из методов оплаты в боте. Пользователи смогут выбирать его при покупке подписки.

## Тестирование

Для тестирования платежей можно использовать тестовый режим Platega (если доступен) или реальные платежи на небольшие суммы.

## Архитектура интеграции

### Основные компоненты

1. **PlategaGateway** (`src/infrastructure/payment_gateways/platega.py`)
   - Класс, реализующий интерфейс `BasePaymentGateway`
   - Обрабатывает создание платежей и webhook'и

2. **PlategaGatewaySettingsDto** (`src/infrastructure/database/models/dto/payment_gateway.py`)
   - DTO для хранения настроек шлюза

3. **PaymentGatewayType.PLATEGA** (`src/core/enums.py`)
   - Enum значение для идентификации шлюза

### Методы API Platega

- **POST /transaction/process** — создание платежной транзакции
- **GET /transaction/{id}** — проверка статуса транзакции
- **Webhook POST** — уведомление об изменении статуса транзакции

### Обработка статусов

Platega отправляет следующие статусы в webhook'ах:

- `CONFIRMED` → `TransactionStatus.COMPLETED`
- `CANCELED` → `TransactionStatus.CANCELED`
- `PENDING` → не обрабатывается через webhook (только через polling)

## Безопасность

1. **Верификация webhook'ов**: Все входящие webhook'и проверяются по заголовкам `X-MerchantId` и `X-Secret`
2. **Хранение секретов**: API Secret хранится в зашифрованном виде в базе данных
3. **HTTPS**: Все запросы к Platega API выполняются по HTTPS

## Устранение неполадок

### Webhook не приходит

1. Проверьте, что URL правильно настроен в личном кабинете Platega
2. Убедитесь, что домен доступен из интернета
3. Проверьте логи бота на наличие ошибок

### Ошибка авторизации

1. Проверьте корректность `merchant_id` и `api_secret`
2. Убедитесь, что учетные данные не содержат лишних пробелов
3. Проверьте, что учетные данные актуальны в личном кабинете Platega

### Платеж не создается

1. Проверьте логи бота на наличие ошибок API
2. Убедитесь, что сумма платежа соответствует требованиям Platega
3. Проверьте, что валюта поддерживается (по умолчанию RUB)

## Дополнительная информация

- [Документация Platega.io API](https://docs.platega.io/)
- [Базовая документация проекта](../README.ru_RU.md)
